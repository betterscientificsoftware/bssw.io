name: Wikize Refs Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**.md'
      - '!docs/**'
      - '!.github/**'

jobs:
  wikize-refs-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run wikize-refs on each file
        run: |
          set +e -x
          exstat=0
          files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          for file in $files; do
            utils/wikize_refs.py -u "$file"
            if [[ $? -ne 0 ]]; then
                echo "$file needs wiki refs updated"
                exstat=1
            fi
          done
          exit $exstat
